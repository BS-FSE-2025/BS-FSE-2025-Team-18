<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Customer Gallery</title>
  <link rel="stylesheet" href="styles/customer-gallery.css">
</head>
<body>
  <header>
    <div class="logo">
      <img src="images/IMG_6583.png" alt="LOGO" />
    </div>
    <nav>
      <a href="homepage-customer.html">Home</a>
      <a href="customer-gallery.html" class="active">Gallery</a>
      <a href="cart.html">Cart</a>
    </nav>
  </header>

  <main>
    <section id="gallery-projects" class="gallery-grid"></section>
  </main>

  <!-- Modal to display project details -->
  <div id="projectModal" class="modal">
    <div class="modal-content">
      <span class="close" onclick="closeModal()">&times;</span>
      <h2 id="modalProjectName"></h2>
      <img id="modalProjectImage" src="" alt="Project Image">
      <p id="modalProjectDescription"></p>
      <div id="modalProjectProducts"></div>
      <p id="modalTotalCost"></p>
      <button onclick="closeModal()" class="close-modal-button">Close</button>
    </div>
  </div>

  <footer>
    <p>&copy; 2024 RenovaCalc. All rights reserved.</p>
  </footer>

  <script>
    const API_URL = "http://localhost:3000/api/gallery"; // Gallery API endpoint

    // Fetch gallery projects and display them
    document.addEventListener("DOMContentLoaded", () => {
      fetchGalleryProjects();
    });

    async function fetchGalleryProjects() {
      try {
        const response = await fetch(API_URL);
        const projects = await response.json();
        console.log("Fetched Projects:", projects);  // Debugging line
        displayGalleryProjects(projects);
      } catch (error) {
        console.error("Error fetching gallery projects:", error);
      }
    }

    function displayGalleryProjects(projects) {
      const galleryContainer = document.getElementById("gallery-projects");
      galleryContainer.innerHTML = ""; // Clear any existing content

      projects.forEach(project => {
        let totalCost = 0;
        project.products.forEach(item => {
          totalCost += item.price * item.quantity; // Calculate total cost based on price and quantity
        });

        const projectCard = document.createElement("div");
        projectCard.classList.add("gallery-card");

        projectCard.innerHTML = `
          <img src="${project.image}" alt="${project.name}">
          <h3>${project.name}</h3>
          <p>${project.description}</p>
          <p>Total Cost: $${totalCost.toFixed(2)}</p> <!-- Display Total Cost -->
          <button class="open-project-button" data-project-id="${project._id}">Open Project</button>
        `;

        galleryContainer.appendChild(projectCard);
      });

      // Attach event listeners to buttons after content is rendered
      const openProjectButtons = document.querySelectorAll(".open-project-button");
      openProjectButtons.forEach(button => {
        button.addEventListener("click", function() {
          const projectId = button.getAttribute("data-project-id");
          openProjectModal(projectId);
        });
      });
    }

    async function openProjectModal(projectId) {
      const modal = document.getElementById("projectModal");

      try {
        const response = await fetch(`${API_URL}/${projectId}`);
        const project = await response.json();

        // Populate the modal with project details
        document.getElementById("modalProjectName").textContent = project.name;
        document.getElementById("modalProjectImage").src = project.image;
        document.getElementById("modalProjectDescription").textContent = project.description;

        // Display the project items (products)
        const productsContainer = document.getElementById("modalProjectProducts");
        if (Array.isArray(project.products) && project.products.length > 0) {
          productsContainer.innerHTML = project.products.map(item => `
            <div class="product-item">
              <img src="${item.image}" alt="${item.name}">
              <p>${item.name} - $${item.price}</p>
              <label for="quantity-${item.productId}">Quantity:</label>
              <input type="number" id="quantity-${item.productId}" value="1" min="1">
              <button onclick="addToCart('${item.productId}', '${item.name}', '${item.price}')">Add to Cart</button>
            </div>
          `).join('');
        } else {
          productsContainer.innerHTML = "<p>No products available for this project.</p>";
        }

        // Calculate and display the total cost of the items in the project
        const totalCost = project.products.reduce((total, item) => {
          const quantity = document.getElementById(`quantity-${item.productId}`).value || 1;
          return total + (item.price * quantity);
        }, 0);

        document.getElementById("modalTotalCost").textContent = `Total Cost: $${totalCost}`;

        // Open the modal
        modal.style.display = "block";
      } catch (error) {
        console.error("Error opening project modal:", error);
      }
    }

    function closeModal() {
      const modal = document.getElementById("projectModal");
      modal.style.display = "none";
    }

    function addToCart(productId, name, price) {
      const quantity = document.getElementById(`quantity-${productId}`).value;
      const cart = JSON.parse(localStorage.getItem("cart")) || [];

      cart.push({ productId, name, price, quantity: parseInt(quantity) });
      localStorage.setItem("cart", JSON.stringify(cart));

      alert(`${name} has been added to the cart.`);
    }
  </script>
</body>
</html>
