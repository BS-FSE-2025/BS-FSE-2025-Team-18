<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>My Projects</title>
  <link rel="stylesheet" href="styles/contractor-projects.css">
  <link href="https://fonts.googleapis.com/css2?family=Nunito:wght@200;400;600;800&display=swap" rel="stylesheet">
</head>
<body>
    <header>
        <div class="logo">
            <img src="../images/IMG_6583.png" alt="LOGO" />
            <div id="accessibility-tools">
              <button id="increase-font">A+</button>
              <button id="decrease-font">A-</button>
              <button id="reset-font">Reset</button>
            </div>
          </div>
    
        <div class="header-content">
          <nav>
            <a href="homepage-contractor.html">Home</a>
            <a href="Contractor-Projects.html" class="active">My Projects</a>
            <a href="aboutus.html">About Us</a>
            <a href="CheckList/CheckListContractor.html">CheckList</a>
          </nav>
    
          <div class="profile-menu">
            <img src="images/avatar-logo.jpg" width="50" onclick="toggleMenu()" alt="Profile" />
            <div class="sub-menu-wrap" id="subMenu">
              <div class="sub-menu">
                <div class="user-info">
                  <img src="images/avatar-logo.jpg" alt="User" />
                  <h2><span id="username"></span></h2>
                </div>
                <hr />
                <a href="contractor-profile.html" class="sub-menu-link">
                  <img src="images/profile images/profile.png" alt="Profile" />
                  <p>Edit Profile</p>
                </a>
                <a href="" class="sub-menu-link">
                  <img src="images/profile images/setting.png" alt="Settings" />
                  <p>Settings</p>
                </a>
                <a href="" class="sub-menu-link">
                  <img src="images/profile images/help.png" alt="Help" />
                  <p>Help</p>
                </a>
                <a href="main_page.html" class="sub-menu-link" onclick="logout()">
                  <img src="images/profile images/logout.png" alt="Logout" />
                  <p>Logout</p>
                </a>
              </div>
            </div>
          </div>
        </div>
    </header>
    
    <main>
        <section id="projects">
            <div class="add-project">
                <h2>Add a New Project</h2>
                <form id="addProjectForm">
                    <input type="text" id="projectName" placeholder="Project Name" required />
                    <textarea id="projectDescription" placeholder="Project Description" required></textarea>
                    <button type="submit">Add Project</button>
                </form>
            </div>
            <div id="project-list"></div>
        </section>
    </main>

    <footer>
        <p>&copy; 2024 RenovaCalc. All rights reserved.</p>
    </footer>

    <script>
        const API_URL = "http://localhost:3000/api/projects";

        document.addEventListener("DOMContentLoaded", () => {
            displayProjects();
        });

        async function fetchProjects() {
            const token = localStorage.getItem("token");

            if (!token) {
                alert("You must be logged in to view your projects.");
                return [];
            }

            try {
                const response = await fetch(API_URL, {
                    method: "GET",
                    headers: {
                        "Authorization": `Bearer ${token}`,
                        "Content-Type": "application/json",
                    }
                });

                if (!response.ok) throw new Error("Failed to fetch projects.");

                return await response.json();
            } catch (error) {
                alert("Error fetching projects: " + error.message);
                return [];
            }
        }

        async function displayProjects() {
    const projects = await fetchProjects();
    const projectList = document.getElementById("project-list");
    projectList.innerHTML = "";

    projects.forEach(project => {
        const projectCard = document.createElement("div");
        projectCard.classList.add("project-card");
        projectCard.innerHTML = `
        <div class="project-summary" onclick="toggleDetails('${project._id}')">
            <h3>${project.name}</h3>
            <p>${project.description}</p>
            <p>Status: <strong>${project.status}</strong></p>
        </div>
        <div class="project-details" id="details-${project._id}" style="display: none;">
            <h4>Products in Project:</h4>
            <div class="product-list">
                ${
                    project.products.length > 0
                        ? project.products.map(product => `
                            <div class="product-item">
                                <img src="${product.image}" alt="${product.name}" style="width:50px; height:50px; border-radius: 5px; margin-right: 10px;" />
                                <p>Product Name: ${product.name || "Unknown"}</p>
                                <p>Quantity: ${product.quantity}</p>
                                <button onclick="removeProductFromProject('${project._id}', '${product.productId}')">Delete Product</button>
                            </div>
                        `).join("")
                        : "<p>No products added.</p>"
                }
            </div>
            <div class="project-actions">
                <button class="edit-project" onclick="editProject('${project._id}')">Edit Project</button>
                <button class="delete-project" onclick="deleteProject('${project._id}')">Delete Project</button>
            </div>
        </div>
        `;
        projectList.appendChild(projectCard);
    });
}

async function removeProductFromProject(projectId, productId) {
    const token = localStorage.getItem("token");

    if (!token) {
        alert("You must be logged in to perform this action.");
        return;
    }

    try {
        const response = await fetch(`http://localhost:3000/api/projects/${projectId}/removeProduct`, {
            method: "PUT",
            headers: {
                "Authorization": `Bearer ${token}`,
                "Content-Type": "application/json",
            },
            body: JSON.stringify({ productId }), // שליחת productId
        });

        if (!response.ok) {
            const errorData = await response.json();
            console.error("Server Error:", errorData);
            throw new Error(errorData.message || "Failed to remove product from project.");
        }

        alert("Product removed successfully!");
        await displayProjects(); // רענון הרשימה לאחר מחיקה
    } catch (error) {
        alert("Error removing product: " + error.message);
    }
}


        function toggleDetails(projectId) {
            const details = document.getElementById(`details-${projectId}`);
            if (details.style.display === "none" || !details.style.display) {
                details.style.display = "block";
            } else {
                details.style.display = "none";
            }
        }

        document.getElementById("addProjectForm").addEventListener("submit", async function (event) {
            event.preventDefault();

            const projectName = document.getElementById("projectName").value;
            const projectDescription = document.getElementById("projectDescription").value;
            const token = localStorage.getItem("token");

            if (!projectName || !projectDescription) {
                alert("Please fill all fields.");
                return;
            }

            if (!token) {
                alert("Token not found, please log in again.");
                return;
            }

            try {
                const response = await fetch(API_URL, {
                    method: "POST",
                    headers: {
                        "Authorization": `Bearer ${token}`,
                        "Content-Type": "application/json",
                    },
                    body: JSON.stringify({ name: projectName, description: projectDescription }),
                });

                if (!response.ok) throw new Error("Failed to add project.");
                alert("Project added successfully!");
                document.getElementById("addProjectForm").reset();
                await displayProjects();
            } catch (error) {
                alert("Error adding project: " + error.message);
            }
        });
        async function deleteProject(projectId) {
    if (!confirm("Are you sure you want to delete this project?")) return;

    const token = localStorage.getItem("token");

    try {
        const response = await fetch(`http://localhost:3000/api/projects/${projectId}`, {
            method: "DELETE",
            headers: {
                "Authorization": `Bearer ${token}`,
                "Content-Type": "application/json",
            },
        });

        if (!response.ok) throw new Error("Failed to delete project.");
        alert("Project deleted successfully!");
        await displayProjects(); // עדכון הרשימה לאחר מחיקה
    } catch (error) {
        alert("Error deleting project: " + error.message);
    }
}
async function editProject(projectId) {
    const newName = prompt("Enter the new project name:");
    const newDescription = prompt("Enter the new project description:");
    const newStatus = prompt("Enter the new status (Pending/In Progress/Completed):");

    if (!newName || !newDescription || !newStatus) {
        alert("Please fill all fields.");
        return;
    }

    const token = localStorage.getItem("token");

    try {
        const response = await fetch(`http://localhost:3000/api/projects/${projectId}`, {
            method: "PUT",
            headers: {
                "Authorization": `Bearer ${token}`,
                "Content-Type": "application/json",
            },
            body: JSON.stringify({
                name: newName,
                description: newDescription,
                status: newStatus,
            }),
        });

        if (!response.ok) throw new Error("Failed to update project.");
        alert("Project updated successfully!");
        await displayProjects(); // עדכון הרשימה לאחר עריכה
    } catch (error) {
        alert("Error updating project: " + error.message);
    }
}


        function logout() {
            localStorage.clear();
            alert("You have been logged out.");
            window.location.href = "main_page.html";
        }

        function toggleMenu() {
            const subMenu = document.getElementById("subMenu");
            subMenu.classList.toggle("open-menu");
        }
    </script>
    <script src="accessability.js"></script>
</body>
</html>
